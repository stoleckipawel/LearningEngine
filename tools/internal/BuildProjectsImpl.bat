@echo off
:: ============================================================================
:: BuildProjectsImpl.bat - Internal project build implementation
:: ============================================================================
:: Builds projects under projects/ for a specified configuration.
:: Can build all projects or a specific project.
::
:: Usage: BuildProjectsImpl.bat <Configuration> [ProjectName]
::   Configuration: Debug | Release | RelWithDebInfo
::   ProjectName: Optional - specific project name or "ALL" for all projects
::
:: Environment:
::   PARENT_BATCH  - When set, suppresses pause on completion
::   LOG_CAPTURED  - Indicates logging is already active
::   LOGFILE       - Path to current log file
:: ============================================================================

setlocal enabledelayedexpansion

:: ---------------------------------------------------------------------------
:: Path configuration
:: ---------------------------------------------------------------------------
set "ARCH=x64"
set "SCRIPT_DIR=%~dp0"
:: Script resides in tools\internal; repository root is two levels up
for %%I in ("%SCRIPT_DIR%..\..\") do set "SRC_DIR=%%~fI"
set "BUILD_DIR=!SRC_DIR!build"
set "PROJECTS_DIR=!SRC_DIR!projects"

:: ---------------------------------------------------------------------------
:: Logging bootstrap (if not already captured by parent)
:: ---------------------------------------------------------------------------
if not defined LOG_CAPTURED (
    call "%SCRIPT_DIR%BootstrapLog.bat" "%~f0" %*
    exit /B %ERRORLEVEL%
)

:: ---------------------------------------------------------------------------
:: Parse arguments
:: ---------------------------------------------------------------------------
set "CONFIG=%~1"
if "%CONFIG%"=="" set "CONFIG=Debug"

set "TARGET_PROJECT=%~2"
if "%TARGET_PROJECT%"=="" set "TARGET_PROJECT=ALL"

:: MSBuild properties for RelWithDebInfo: preserve full debug symbols
set "MSBUILD_EXTRA="
if /I "%CONFIG%"=="RelWithDebInfo" (
    echo [LOG] RelWithDebInfo: Enabling full debug information.
    set "MSBUILD_EXTRA=/p:DebugSymbols=true /p:DebugType=full /p:GenerateDebugInformation=true /p:Optimize=true /p:LinkIncremental=false"
)

:: ---------------------------------------------------------------------------
:: Ensure solution exists (generate if missing)
:: ---------------------------------------------------------------------------
set "PROJECT_NAME="
for /f "tokens=2 delims=( " %%P in ('findstr /i "project(" "!SRC_DIR!CMakeLists.txt"') do (
    set "RAW_PROJECT_NAME=%%P"
)
for /f "delims=) tokens=1" %%A in ("!RAW_PROJECT_NAME!") do set "PROJECT_NAME=%%A"
set "PROJECT_NAME=!PROJECT_NAME: =!"
set "SOLUTION_FILE=!BUILD_DIR!\!PROJECT_NAME!.sln"

if not exist "!SOLUTION_FILE!" (
    echo [LOG] Solution not found. Invoking BuildSolution.bat...
    set "PARENT_BATCH=1"
    call "!SRC_DIR!BuildSolution.bat" CONTINUE
    set "PARENT_BATCH="
    if errorlevel 1 (
        echo [ERROR] Solution generation failed.
        call :FINISH 1
    )
)

:: ---------------------------------------------------------------------------
:: Build project(s)
:: ---------------------------------------------------------------------------
set "BUILD_FAILED=0"
set "BUILD_COUNT=0"

if /I "!TARGET_PROJECT!"=="ALL" (
    :: Build all projects
    for /D %%S in ("!PROJECTS_DIR!\*") do (
        set "PROJ_NAME=%%~nxS"
        :: Skip TemplateProject
        if /I "!PROJ_NAME!" NEQ "TemplateProject" (
            set "PROJECT_VCXPROJ=!BUILD_DIR!\projects\!PROJ_NAME!\!PROJ_NAME!.vcxproj"
            
            if exist "!PROJECT_VCXPROJ!" (
                set /A "BUILD_COUNT+=1"
                echo [LOG] Building: !PROJ_NAME! [!CONFIG!]
                msbuild "!PROJECT_VCXPROJ!" /p:Configuration=!CONFIG! /p:Platform=!ARCH! !MSBUILD_EXTRA! /nologo /v:minimal
                if errorlevel 1 (
                    echo [ERROR] Build failed: !PROJ_NAME! [!CONFIG!]
                    set "BUILD_FAILED=1"
                ) else (
                    echo [SUCCESS] !PROJ_NAME! [!CONFIG!] - Output: bin\!CONFIG!
                )
            )
        )
    )
) else (
    :: Build specific project
    set "PROJECT_VCXPROJ=!BUILD_DIR!\projects\!TARGET_PROJECT!\!TARGET_PROJECT!.vcxproj"
    
    if exist "!PROJECT_VCXPROJ!" (
        set /A "BUILD_COUNT+=1"
        echo [LOG] Building: !TARGET_PROJECT! [!CONFIG!]
        msbuild "!PROJECT_VCXPROJ!" /p:Configuration=!CONFIG! /p:Platform=!ARCH! !MSBUILD_EXTRA! /nologo /v:minimal
        if errorlevel 1 (
            echo [ERROR] Build failed: !TARGET_PROJECT! [!CONFIG!]
            set "BUILD_FAILED=1"
        ) else (
            echo [SUCCESS] !TARGET_PROJECT! [!CONFIG!] - Output: bin\!CONFIG!
        )
    ) else (
        echo [ERROR] Project not found: !TARGET_PROJECT!
        echo         Expected: !PROJECT_VCXPROJ!
        set "BUILD_FAILED=1"
    )
)

if "!BUILD_COUNT!"=="0" (
    echo [WARN] No projects were built. Ensure solution is generated.
)

if "!BUILD_FAILED!"=="1" (
    call :FINISH 1
)

if /I "!TARGET_PROJECT!"=="ALL" (
    echo [LOG] All projects built successfully for !CONFIG!.
) else (
    echo [LOG] !TARGET_PROJECT! built successfully for !CONFIG!.
)
call :FINISH 0

:: ---------------------------------------------------------------------------
:: Subroutine: Clean exit with proper endlocal handling
:: ---------------------------------------------------------------------------
:FINISH
set "EXIT_RC=%~1"
set "_TMP_LOGFILE=%LOGFILE%"
set "_TMP_PARENT=%PARENT_BATCH%"
endlocal & set "LOGFILE=%_TMP_LOGFILE%" & set "EXIT_RC=%EXIT_RC%" & set "PARENT_BATCH=%_TMP_PARENT%"

if defined PARENT_BATCH (
    exit /B %EXIT_RC%
)

echo.
echo ============================================================
if "%EXIT_RC%"=="0" (
    echo   [SUCCESS] Project build completed.
) else (
    echo   [ERROR] Project build failed.
)
echo ============================================================
echo.
echo [LOG] Logs: %LOGFILE%
pause
exit /B %EXIT_RC%
