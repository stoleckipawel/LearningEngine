#pragma once

#include "ShaderCompileOptions.h"
#include "ShaderCompileResult.h"
#include <dxcapi.h>
#include <wrl/client.h>
#include <vector>
#include <string>

using Microsoft::WRL::ComPtr;

// Compiles HLSL shaders using the DirectX Shader Compiler (DXC).
// Stateless compiler - create options, call Compile(), get result.
class DxcShaderCompiler
{
  public:
	// Compiles a shader with the given options.
	// Returns a result containing bytecode on success, or error message on failure.
	static ShaderCompileResult Compile(const ShaderCompileOptions& options);

	// Convenience overload: resolves the shader path and builds options automatically.
	// sourcePath: relative path from shader root (e.g., "Passes/Forward/ForwardLitVS.hlsl")
	static ShaderCompileResult
	CompileFromAsset(const std::filesystem::path& sourcePath, ShaderStage stage, const std::string& entryPoint = "main");

  private:
	// Builds the DXC argument list from compile options.
	// Arguments reference strings in the storage vectors - those must outlive the args vector.
	static void BuildCompileArguments(
	    const ShaderCompileOptions& options,
	    const std::wstring& wSourcePath,
	    const std::wstring& wEntryPoint,
	    const std::wstring& wTargetProfile,
	    std::vector<std::wstring>& wIncludeDirs,
	    std::vector<std::wstring>& wDefines,
	    std::vector<LPCWSTR>& outArgs);

	// Extracts bytecode from a successful compilation result.
	static std::vector<uint8_t> ExtractBytecode(IDxcResult* result);

	// Extracts error/warning messages from compilation output.
	static std::string ExtractErrorMessage(IDxcResult* result);

	// Saves shader symbols (PDB) to disk for debugging.
	static void SaveShaderSymbols(IDxcResult* result, const std::filesystem::path& sourcePath);
};
